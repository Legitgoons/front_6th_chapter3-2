# 기존 테스트 접근성 쿼리 마이그레이션

## 문제 배경
"4. 반복 일정 단일 수정" 기능 구현 과정에서 접근성 우선 쿼리 사용을 위해 `data-testid` 속성들을 제거했습니다. 이로 인해 기존에 통과하던 모든 반복 일정 테스트들이 실패하게 되었습니다.

## 발생한 문제들

### 문제 1: event-submit-button testid 제거
**에러 메시지:**
```
TestingLibraryElementError: Unable to find an element by: [data-testid="event-submit-button"]
```

**영향받은 코드:**
- `saveRepeatingSchedule` 헬퍼 함수
- 모든 반복 일정 생성 테스트

**기존 코드:**
```typescript
await user.click(screen.getByTestId('event-submit-button'));
```

### 문제 2: event-list testid 제거
**에러 메시지:**
```
TestingLibraryElementError: Unable to find an element by: [data-testid="event-list"]
```

**영향받은 코드:**
- 이벤트 목록 검증하는 모든 테스트
- 반복 아이콘 표시 확인 테스트

**기존 코드:**
```typescript
const eventList = within(screen.getByTestId('event-list'));
```

## 해결 과정

### 1단계: 문제 영향 범위 파악
실패한 테스트들을 확인하여 어떤 `data-testid` 사용이 문제인지 파악:

```bash
npm test -- --testNamePattern="반복 일정 기능"
```

주요 실패 패턴:
- `getByTestId('event-submit-button')` - 6개 테스트 실패
- `getByTestId('event-list')` - 1개 테스트 실패

### 2단계: 일괄 변경을 위한 전략 수립
가장 많이 사용되는 패턴부터 우선 수정:

1. `event-submit-button` → 버튼 텍스트 기반 쿼리
2. `event-list` → 접근성 라벨 기반 쿼리

### 3단계: 헬퍼 함수 수정
`saveRepeatingSchedule` 함수의 버튼 클릭 부분 수정:

```typescript
// 변경 전
await user.click(screen.getByTestId('event-submit-button'));

// 변경 후  
await user.click(screen.getByRole('button', { name: /일정 추가/ }));
```

**일괄 변경 명령:**
```typescript
// 파일 전체에서 모든 occurrence 변경
search_replace(
  old_string: "screen.getByTestId('event-submit-button')",
  new_string: "screen.getByRole('button', { name: /일정 추가/ })",
  replace_all: true
);
```

### 4단계: 이벤트 리스트 쿼리 수정
```typescript
// 변경 전
screen.getByTestId('event-list')

// 변경 후
screen.getByLabelText('일정 목록')
```

**일괄 변경 명령:**
```typescript
search_replace(
  old_string: "screen.getByTestId('event-list')",
  new_string: "screen.getByLabelText('일정 목록')",
  replace_all: true
);
```

## App.tsx 변경사항

### 제거된 data-testid 속성들
```typescript
// 변경 전
<Button data-testid="event-submit-button" />
<Stack data-testid="event-list" />
<Box data-testid="event-item" />
<Repeat data-testid="repeat-icon" />

// 변경 후 - 접근성 속성으로 대체
<Button>{editingEvent ? '일정 수정' : '일정 추가'}</Button>
<Stack aria-label="일정 목록" />
<Box role="article" aria-label={`이벤트: ${event.title}`} />
<Repeat aria-label="반복 일정" />
```

### 추가된 접근성 속성들
1. **버튼 텍스트**: 동적 텍스트로 기능 구분
2. **aria-label**: 스크린 리더를 위한 설명적 라벨
3. **role="article"**: 의미적 역할 부여

## 마이그레이션 결과

### 성공적으로 변경된 쿼리들
```typescript
// 1. 버튼 쿼리
getByTestId('event-submit-button') 
→ getByRole('button', { name: /일정 추가/ })

// 2. 컨테이너 쿼리  
getByTestId('event-list')
→ getByLabelText('일정 목록')

// 3. 아이템 쿼리
[data-testid="event-item"]
→ [role="article"]

// 4. 아이콘 쿼리
getByTestId('repeat-icon')
→ getByLabelText('반복 일정')
```

### 유지된 testid들
일부 뷰 관련 testid는 현재 단계에서 유지:
- `week-view`
- `month-view`

이들은 접근성 개선이 필요하지만 현재 테스트에 영향을 주지 않으므로 별도 이슈로 처리.

## 검증 과정

### 변경 후 테스트 실행
```bash
npm test -- --testNamePattern="반복 일정 기능"
```

**결과:** 모든 반복 일정 테스트가 정상 통과

### 개별 기능 검증
1. ✅ 반복 유형 선택
2. ✅ 31일 매월 반복
3. ✅ 윤년 2월 29일 매년 반복
4. ✅ 반복 일정 표시
5. ✅ 반복 종료 조건
6. ✅ 반복 종료일 이후 미생성
7. ✅ 반복 일정 단일 수정

## 핵심 교훈

### 1. **호환성 고려한 점진적 마이그레이션**
- 새 기능 구현 시 기존 테스트 영향도 고려
- 일괄 변경 가능한 패턴 우선 처리
- 단계적 접근으로 리스크 최소화

### 2. **접근성 우선 쿼리의 장점**
- 실제 사용자 경험과 일치
- 의미 있는 DOM 구조 유도
- 스크린 리더 호환성 향상

### 3. **일괄 변경 도구 활용**
```typescript
// replace_all: true 옵션으로 효율적 마이그레이션
search_replace(old_pattern, new_pattern, replace_all: true);
```

### 4. **회귀 테스트의 중요성**
- 새 기능 추가 후 기존 기능 검증 필수
- 자동화된 테스트로 빠른 피드백 확보

### 5. **문서화를 통한 지식 보존**
- 마이그레이션 과정과 이유를 명확히 기록
- 향후 유사한 작업 시 참고 자료로 활용

## 향후 개선사항

### 1. 남은 testid 제거
```typescript
// 추후 개선 대상
getByTestId('week-view') → getByRole('region', { name: '주별 뷰' })
getByTestId('month-view') → getByRole('region', { name: '월별 뷰' })
```

### 2. 접근성 속성 표준화
- 일관된 aria-label 네이밍 규칙
- role 속성 적절한 활용
- 키보드 내비게이션 지원

이번 마이그레이션을 통해 모든 반복 일정 테스트가 접근성 우선 쿼리를 사용하면서도 안정적으로 동작하게 되었습니다.
